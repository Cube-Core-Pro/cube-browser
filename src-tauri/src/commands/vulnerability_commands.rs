use crate::services::vulnerability_scanner::{ScanTarget, VulnerabilityScanner};
use tauri::State;

/// Start vulnerability scan
#[tauri::command]
pub async fn start_vulnerability_scan(
    url: String,
    scan_depth: Option<u32>,
    max_urls: Option<u32>,
    vulnerability_scanner: State<'_, VulnerabilityScanner>,
) -> Result<String, String> {
    let target = ScanTarget {
        id: uuid::Uuid::new_v4().to_string(),
        url,
        scope: vec!["*".to_string()],
        exclusions: Vec::new(),
        auth_type: None,
        auth_credentials: None,
        scan_depth: scan_depth.unwrap_or(3),
        max_urls: max_urls.unwrap_or(100),
    };

    vulnerability_scanner
        .start_scan(target)
        .map_err(|e| e.to_string())
}

/// Get scan report
#[tauri::command]
pub async fn get_scan_report(
    scan_id: String,
    vulnerability_scanner: State<'_, VulnerabilityScanner>,
) -> Result<serde_json::Value, String> {
    vulnerability_scanner
        .get_scan_report(&scan_id)
        .map(|report| serde_json::to_value(report).unwrap())
        .map_err(|e| e.to_string())
}

/// Get all scans
#[tauri::command]
pub async fn get_all_scans(
    vulnerability_scanner: State<'_, VulnerabilityScanner>,
) -> Result<Vec<serde_json::Value>, String> {
    Ok(vulnerability_scanner
        .get_all_scans()
        .into_iter()
        .map(|s| serde_json::to_value(s).unwrap())
        .collect())
}

/// Stop scan
#[tauri::command]
pub async fn stop_scan(
    scan_id: String,
    vulnerability_scanner: State<'_, VulnerabilityScanner>,
) -> Result<(), String> {
    vulnerability_scanner
        .stop_scan(&scan_id)
        .map_err(|e| e.to_string())
}

/// Delete scan
#[tauri::command]
pub async fn delete_scan(
    scan_id: String,
    vulnerability_scanner: State<'_, VulnerabilityScanner>,
) -> Result<(), String> {
    vulnerability_scanner
        .delete_scan(&scan_id)
        .map_err(|e| e.to_string())
}

/// Export scan report
#[tauri::command]
pub async fn export_scan_report(
    scan_id: String,
    format: String,
    vulnerability_scanner: State<'_, VulnerabilityScanner>,
) -> Result<String, String> {
    vulnerability_scanner
        .export_report(&scan_id, &format)
        .map_err(|e| e.to_string())
}
