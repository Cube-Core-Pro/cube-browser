/**
 * Vulnerability Scanner Service
 * 
 * Automated vulnerability scanning and reporting.
 * 
 * @module vulnerabilityService
 */

import { invoke } from '@tauri-apps/api/core';

// ============================================================================
// TYPES
// ============================================================================

export interface VulnerabilityScan {
  id: string;
  target: string;
  status: 'running' | 'completed' | 'failed';
  progress: number;
  startedAt: number;
  completedAt?: number;
  vulnerabilitiesFound: number;
}

export interface VulnerabilityReport {
  scanId: string;
  target: string;
  vulnerabilities: Vulnerability[];
  summary: {
    total: number;
    critical: number;
    high: number;
    medium: number;
    low: number;
  };
  generatedAt: number;
}

export interface Vulnerability {
  id: string;
  title: string;
  severity: 'critical' | 'high' | 'medium' | 'low';
  description: string;
  cve?: string;
  cvss?: number;
  affectedComponent: string;
  remediation: string;
}

export interface ScanOptions {
  depth?: 'quick' | 'standard' | 'deep';
  includeNetwork?: boolean;
  includeWeb?: boolean;
  includePorts?: boolean;
}

// ============================================================================
// API
// ============================================================================

/**
 * Start vulnerability scan
 */
export async function startScan(target: string, options?: ScanOptions): Promise<string> {
  try {
    return await invoke<string>('start_vulnerability_scan', { target, options });
  } catch (error) {
    throw new Error(`Failed to start scan: ${error}`);
  }
}

/**
 * Get scan report
 */
export async function getReport(scanId: string): Promise<VulnerabilityReport> {
  try {
    return await invoke<VulnerabilityReport>('get_scan_report', { scanId });
  } catch (error) {
    throw new Error(`Failed to get report: ${error}`);
  }
}

/**
 * Get all scans
 */
export async function getAllScans(): Promise<VulnerabilityScan[]> {
  try {
    return await invoke<VulnerabilityScan[]>('get_all_scans');
  } catch (error) {
    throw new Error(`Failed to get scans: ${error}`);
  }
}

/**
 * Stop running scan
 */
export async function stopScan(scanId: string): Promise<void> {
  try {
    await invoke<void>('stop_scan', { scanId });
  } catch (error) {
    throw new Error(`Failed to stop scan: ${error}`);
  }
}

/**
 * Delete scan and its report
 */
export async function deleteScan(scanId: string): Promise<void> {
  try {
    await invoke<void>('delete_scan', { scanId });
  } catch (error) {
    throw new Error(`Failed to delete scan: ${error}`);
  }
}

/**
 * Export scan report to file
 */
export async function exportReport(
  scanId: string,
  format: 'json' | 'pdf' | 'html' | 'csv',
  outputPath: string
): Promise<void> {
  try {
    await invoke<void>('export_scan_report', { scanId, format, outputPath });
  } catch (error) {
    throw new Error(`Failed to export report: ${error}`);
  }
}

// ============================================================================
// HELPERS
// ============================================================================

export async function getActiveScans(): Promise<VulnerabilityScan[]> {
  const scans = await getAllScans();
  return scans.filter(s => s.status === 'running');
}

export async function getCriticalVulnerabilities(scanId: string): Promise<Vulnerability[]> {
  const report = await getReport(scanId);
  return report.vulnerabilities.filter(v => v.severity === 'critical');
}

export async function getCompletedScans(): Promise<VulnerabilityScan[]> {
  const scans = await getAllScans();
  return scans.filter(s => s.status === 'completed');
}

/**
 * Default export
 */
export const vulnerabilityService = {
  startScan,
  getReport,
  getAllScans,
  stopScan,
  deleteScan,
  exportReport,
  getActiveScans,
  getCriticalVulnerabilities,
  getCompletedScans,
};

export default vulnerabilityService;
