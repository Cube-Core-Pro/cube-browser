<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CUBE Nexum - Settings</title>
  <style>
    :root {
      --primary: #7c3aed;
      --primary-hover: #6d28d9;
      --bg: #ffffff;
      --bg-secondary: #f9fafb;
      --bg-card: #ffffff;
      --text: #1f2937;
      --text-secondary: #6b7280;
      --border: #e5e7eb;
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
      --input-bg: #ffffff;
    }

    /* Dark Theme */
    [data-theme="dark"] {
      --bg: #0a0a0f;
      --bg-secondary: #111118;
      --bg-card: #16161d;
      --text: #f4f4f5;
      --text-secondary: #a1a1aa;
      --border: rgba(255, 255, 255, 0.1);
      --input-bg: #1e1e26;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
      background: var(--bg-secondary);
      color: var(--text);
      line-height: 1.5;
      transition: background 0.3s, color 0.3s;
    }

    .settings-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 24px;
    }

    .settings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 32px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .settings-header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .settings-header-logo {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary), #a855f7);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
    }

    .settings-header-text h1 {
      font-size: 24px;
      font-weight: 700;
    }

    .settings-header-text p {
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* Theme Toggle Button */
    .theme-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text);
      transition: all 0.2s;
    }

    .theme-toggle:hover {
      border-color: var(--primary);
    }

    .theme-toggle .icon {
      font-size: 18px;
    }

    .settings-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      transition: background 0.3s, border-color 0.3s;
    }

    .settings-section h2 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .settings-section h2 .icon {
      width: 24px;
      height: 24px;
      background: var(--primary);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 14px;
    }

    .settings-section p.description {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
    }

    .form-label small {
      display: block;
      font-weight: 400;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .form-label small a {
      color: var(--primary);
    }

    .form-input {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      background: var(--input-bg);
      color: var(--text);
      transition: border-color 0.2s, box-shadow 0.2s, background 0.3s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
    }

    .form-input.mono {
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
      font-size: 13px;
    }

    .input-with-button {
      display: flex;
      gap: 8px;
    }

    .input-with-button .form-input {
      flex: 1;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
      box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
      transform: translateY(-1px);
    }

    .btn-primary:active {
      transform: translateY(0) scale(0.98);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text);
      border: 2px solid var(--border);
    }

    .btn-secondary:hover {
      border-color: var(--primary);
      background: rgba(124, 58, 237, 0.05);
      transform: translateY(-1px);
    }

    .btn-secondary:active {
      transform: translateY(0) scale(0.98);
    }

    .btn-icon {
      padding: 10px;
      min-width: 42px;
    }

    .btn-sm {
      padding: 8px 14px;
      font-size: 13px;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 13px;
      margin-top: 12px;
    }

    .status-indicator.success {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }

    .status-indicator.error {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error);
    }

    .status-indicator.warning {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }

    .status-indicator.neutral {
      background: var(--bg-secondary);
      color: var(--text-secondary);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .form-select {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      background: var(--input-bg);
      color: var(--text);
      cursor: pointer;
      transition: background 0.3s, border-color 0.2s;
    }

    .form-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .settings-card {
      padding: 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
      position: relative;
      overflow: hidden;
    }

    .settings-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(124, 58, 237, 0.1) 0%, transparent 100%);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .settings-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(124, 58, 237, 0.15);
    }

    .settings-card:hover::before {
      opacity: 1;
    }

    .settings-card:active {
      transform: translateY(0);
    }

    .settings-card.active {
      border-color: var(--primary);
      background: rgba(124, 58, 237, 0.1);
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
    }

    .settings-card.active::after {
      content: '‚úì';
      position: absolute;
      top: 8px;
      right: 8px;
      width: 20px;
      height: 20px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }

    .settings-card h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      position: relative;
      z-index: 1;
    }

    .settings-card p {
      font-size: 12px;
      color: var(--text-secondary);
      position: relative;
      z-index: 1;
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
      z-index: 1000;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast.success {
      background: var(--success);
      color: white;
    }

    .toast.error {
      background: var(--error);
      color: white;
    }

    .divider {
      height: 1px;
      background: var(--border);
      margin: 20px 0;
    }

    .footer {
      text-align: center;
      padding: 24px;
      color: var(--text-secondary);
      font-size: 13px;
    }

    .footer a {
      color: var(--primary);
      text-decoration: none;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    @media (max-width: 600px) {
      .settings-container {
        padding: 16px;
      }
      
      .settings-section {
        padding: 16px;
      }
    }

    /* Utility Classes */
    .ml-sm {
      margin-left: 8px;
    }

    .mt-sm {
      margin-top: 8px;
    }

    .text-danger {
      color: var(--error);
    }

    .text-muted {
      color: var(--text-secondary);
      font-size: 13px;
    }

    .hidden-input {
      display: none;
    }
  </style>
</head>
<body data-theme="light">
  <div class="settings-container">
    <!-- Header -->
    <div class="settings-header">
      <div class="settings-header-left">
        <div class="settings-header-logo">üîÆ</div>
        <div class="settings-header-text">
          <h1>CUBE Nexum Settings</h1>
          <p>Configure your AI assistants and extension preferences</p>
        </div>
      </div>
      <button type="button" class="theme-toggle" id="theme-toggle" title="Toggle dark/light theme">
        <span class="icon" id="theme-icon">üåô</span>
        <span id="theme-text">Dark</span>
      </button>
    </div>

    <!-- AI Configuration -->
    <div class="settings-section">
      <h2><span class="icon">ü§ñ</span> AI Configuration</h2>
      <p class="description">Configure your AI providers for intelligent automation features.</p>

      <!-- OpenAI -->
      <div class="form-group">
        <label class="form-label">
          OpenAI API Key
          <small>Get your key from <a href="https://platform.openai.com/api-keys" target="_blank" rel="noopener">platform.openai.com/api-keys</a></small>
        </label>
        <div class="input-with-button">
          <input type="password" id="openai-api-key" class="form-input mono" placeholder="sk-proj-..." />
          <button type="button" id="toggle-openai-key" class="btn btn-secondary btn-icon" title="Show/Hide">
            üëÅÔ∏è
          </button>
        </div>
        <div id="openai-status" class="status-indicator neutral">
          <span class="status-dot"></span>
          <span>Not configured</span>
        </div>
      </div>

      <!-- Gemini -->
      <div class="form-group">
        <label class="form-label">
          Google Gemini API Key
          <small>Get your key from <a href="https://makersuite.google.com/app/apikey" target="_blank" rel="noopener">Google AI Studio</a></small>
        </label>
        <div class="input-with-button">
          <input type="password" id="gemini-api-key" class="form-input mono" placeholder="AIza..." />
          <button type="button" id="toggle-gemini-key" class="btn btn-secondary btn-icon" title="Show/Hide">
            üëÅÔ∏è
          </button>
        </div>
        <div id="gemini-status" class="status-indicator neutral">
          <span class="status-dot"></span>
          <span>Not configured</span>
        </div>
      </div>

      <!-- Claude -->
      <div class="form-group">
        <label class="form-label">
          Anthropic Claude API Key
          <small>Get your key from <a href="https://console.anthropic.com/settings/keys" target="_blank" rel="noopener">Anthropic Console</a></small>
        </label>
        <div class="input-with-button">
          <input type="password" id="claude-api-key" class="form-input mono" placeholder="sk-ant-..." />
          <button type="button" id="toggle-claude-key" class="btn btn-secondary btn-icon" title="Show/Hide">
            üëÅÔ∏è
          </button>
        </div>
        <div id="claude-status" class="status-indicator neutral">
          <span class="status-dot"></span>
          <span>Not configured</span>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Model Selection -->
      <div class="form-group">
        <label class="form-label">
          Preferred AI Provider
          <small>Choose which AI to use for chat and automation</small>
        </label>
        <select id="ai-provider" class="form-select" aria-label="Preferred AI Provider">
          <option value="auto">Auto (use available)</option>
          <option value="openai">OpenAI (GPT-5.1)</option>
          <option value="gemini">Google Gemini (2.5 Flash)</option>
          <option value="claude">Anthropic Claude (4 Sonnet)</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">
          OpenAI Model
          <small>Select which GPT model to use</small>
        </label>
        <select id="openai-model" class="form-select" aria-label="OpenAI Model">
          <option value="gpt-5.1">GPT-5.1 (Latest & Best)</option>
          <option value="gpt-4.1">GPT-4.1 (High Performance)</option>
          <option value="gpt-4o">GPT-4o (Balanced)</option>
          <option value="gpt-4o-mini">GPT-4o Mini (Fast & Affordable)</option>
          <option value="o3-mini">o3-mini (Reasoning)</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">
          Gemini Model
          <small>Select which Gemini model to use</small>
        </label>
        <select id="gemini-model" class="form-select" aria-label="Gemini Model">
          <option value="gemini-2.5-flash">Gemini 2.5 Flash (Fastest)</option>
          <option value="gemini-2.5-pro">Gemini 2.5 Pro (Best Quality)</option>
          <option value="gemini-2.0-flash">Gemini 2.0 Flash (Balanced)</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">
          Claude Model
          <small>Select which Claude model to use</small>
        </label>
        <select id="claude-model" class="form-select" aria-label="Claude Model">
          <option value="claude-sonnet-4">Claude 4 Sonnet (Best Quality)</option>
          <option value="claude-3.5-sonnet">Claude 3.5 Sonnet (Balanced)</option>
          <option value="claude-3.5-haiku">Claude 3.5 Haiku (Fast)</option>
        </select>
      </div>

      <button type="button" id="test-ai-connection" class="btn btn-primary">
        üß™ Test AI Connection
      </button>
    </div>

    <!-- Extension Settings -->
    <div class="settings-section">
      <h2><span class="icon">‚öôÔ∏è</span> Extension Settings</h2>
      <p class="description">Configure how the CUBE extension behaves.</p>

      <div class="form-group">
        <div class="checkbox-group">
          <input type="checkbox" id="auto-detect-forms" checked />
          <label for="auto-detect-forms">Automatically detect forms on page load</label>
        </div>
      </div>

      <div class="form-group">
        <div class="checkbox-group">
          <input type="checkbox" id="show-floating-button" checked />
          <label for="show-floating-button">Show floating assistant button</label>
        </div>
      </div>

      <div class="form-group">
        <div class="checkbox-group">
          <input type="checkbox" id="enable-notifications" checked />
          <label for="enable-notifications">Enable desktop notifications</label>
        </div>
      </div>

      <div class="form-group">
        <div class="checkbox-group">
          <input type="checkbox" id="macro-auto-learn" checked />
          <label for="macro-auto-learn">Enable macro auto-learning</label>
        </div>
      </div>
    </div>

    <!-- Appearance -->
    <div class="settings-section">
      <h2><span class="icon">üé®</span> Appearance</h2>
      <p class="description">Customize the look and feel.</p>

      <div class="form-group">
        <label class="form-label">Theme</label>
        <div class="settings-grid">
          <div class="settings-card active" data-theme="elite-purple">
            <h4>üîÆ Elite Purple</h4>
            <p>Default CUBE theme</p>
          </div>
          <div class="settings-card" data-theme="dark">
            <h4>üåô Dark Mode</h4>
            <p>Easy on the eyes</p>
          </div>
          <div class="settings-card" data-theme="light">
            <h4>‚òÄÔ∏è Light Mode</h4>
            <p>Clean and bright</p>
          </div>
          <div class="settings-card" data-theme="midnight">
            <h4>üåå Midnight Blue</h4>
            <p>Deep blue tones</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Data Management -->
    <div class="settings-section">
      <h2><span class="icon">üíæ</span> Data Management</h2>
      <p class="description">Manage your saved data and privacy settings.</p>

      <div class="form-group">
        <button type="button" id="export-data" class="btn btn-secondary">
          üì§ Export All Data
        </button>
        <button type="button" id="import-data" class="btn btn-secondary ml-sm">
          üì• Import Data
        </button>
      </div>

      <div class="divider"></div>

      <div class="form-group">
        <button type="button" id="clear-macros" class="btn btn-secondary">
          üóëÔ∏è Clear Saved Macros
        </button>
        <button type="button" id="clear-chat-history" class="btn btn-secondary ml-sm">
          üóëÔ∏è Clear Chat History
        </button>
      </div>

      <div class="divider"></div>

      <div class="form-group">
        <button type="button" id="reset-all" class="btn btn-secondary text-danger">
          ‚ö†Ô∏è Reset All Settings
        </button>
      </div>
    </div>

    <!-- About -->
    <div class="settings-section">
      <h2><span class="icon">‚ÑπÔ∏è</span> About</h2>
      <div class="form-group">
        <p><strong>CUBE Nexum Connect</strong> v7.0.2</p>
        <p class="text-muted mt-sm">
          Enterprise browser automation and AI-powered productivity tools.
        </p>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <p>Made with üíú by CUBE Team ‚Ä¢ <a href="https://cube-nexum.com" target="_blank" rel="noopener">cube-nexum.com</a></p>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Hidden file input for import -->
  <input type="file" id="import-file-input" accept=".json" class="hidden-input" />

  <script>
    // ==================== STATE ====================
    let settings = {
      openaiApiKey: '',
      geminiApiKey: '',
      claudeApiKey: '',
      aiProvider: 'auto',
      openaiModel: 'gpt-5.1',
      geminiModel: 'gemini-2.5-flash',
      claudeModel: 'claude-sonnet-4',
      autoDetectForms: true,
      showFloatingButton: true,
      enableNotifications: true,
      macroAutoLearn: true,
      theme: 'elite-purple'
    };

    // ==================== DOM ELEMENTS ====================
    const openaiKeyInput = document.getElementById('openai-api-key');
    const geminiKeyInput = document.getElementById('gemini-api-key');
    const openaiStatus = document.getElementById('openai-status');
    const geminiStatus = document.getElementById('gemini-status');
    const aiProviderSelect = document.getElementById('ai-provider');
    const openaiModelSelect = document.getElementById('openai-model');
    const geminiModelSelect = document.getElementById('gemini-model');
    const claudeModelSelect = document.getElementById('claude-model');
    const themeCards = document.querySelectorAll('.settings-card[data-theme]');

    // ==================== INITIALIZATION ====================
    async function init() {
      try {
        const result = await chrome.storage.local.get([
          'openai_apiKey', 'gemini_apiKey', 'claude_apiKey', 'settings', 
          'ai_provider', 'openai_model', 'gemini_model', 'claude_model', 'theme'
        ]);
        
        if (result.openai_apiKey) {
          settings.openaiApiKey = result.openai_apiKey;
          openaiKeyInput.value = '‚Ä¢'.repeat(Math.min(result.openai_apiKey.length, 40));
          updateStatus(openaiStatus, 'success', 'API key configured');
        }
        
        if (result.gemini_apiKey) {
          settings.geminiApiKey = result.gemini_apiKey;
          geminiKeyInput.value = '‚Ä¢'.repeat(Math.min(result.gemini_apiKey.length, 40));
          updateStatus(geminiStatus, 'success', 'API key configured');
        }

        if (result.claude_apiKey) {
          settings.claudeApiKey = result.claude_apiKey;
          const claudeKeyInputEl = document.getElementById('claude-api-key');
          const claudeStatusEl = document.getElementById('claude-status');
          if (claudeKeyInputEl) {
            claudeKeyInputEl.value = '‚Ä¢'.repeat(Math.min(result.claude_apiKey.length, 40));
          }
          if (claudeStatusEl) {
            updateStatus(claudeStatusEl, 'success', 'API key configured');
          }
        }

        if (result.ai_provider) {
          settings.aiProvider = result.ai_provider;
          aiProviderSelect.value = result.ai_provider;
        }

        if (result.openai_model) {
          settings.openaiModel = result.openai_model;
          if (openaiModelSelect) openaiModelSelect.value = result.openai_model;
        }

        if (result.gemini_model) {
          settings.geminiModel = result.gemini_model;
          if (geminiModelSelect) geminiModelSelect.value = result.gemini_model;
        }

        if (result.claude_model) {
          settings.claudeModel = result.claude_model;
          if (claudeModelSelect) claudeModelSelect.value = result.claude_model;
        }

        if (result.theme) {
          settings.theme = result.theme;
          themeCards.forEach(card => {
            card.classList.toggle('active', card.dataset.theme === result.theme);
          });
        }

        if (result.settings) {
          Object.assign(settings, result.settings);
          document.getElementById('auto-detect-forms').checked = settings.autoDetectForms;
          document.getElementById('show-floating-button').checked = settings.showFloatingButton;
          document.getElementById('enable-notifications').checked = settings.enableNotifications;
          document.getElementById('macro-auto-learn').checked = settings.macroAutoLearn;
        }

        console.log('‚úÖ Settings loaded');
      } catch (error) {
        console.error('Failed to load settings:', error);
      }
    }

    // ==================== HELPERS ====================
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function updateStatus(element, type, text) {
      element.className = `status-indicator ${type}`;
      element.querySelector('span:last-child').textContent = text;
    }

    async function saveToStorage(key, value) {
      try {
        await chrome.storage.local.set({ [key]: value });
        return true;
      } catch (error) {
        console.error('Save failed:', error);
        return false;
      }
    }

    // ==================== API KEY HANDLERS ====================
    let openaiKeyVisible = false;
    let geminiKeyVisible = false;
    let claudeKeyVisible = false;
    
    const claudeKeyInput = document.getElementById('claude-api-key');
    const claudeStatus = document.getElementById('claude-status');

    document.getElementById('toggle-openai-key').addEventListener('click', () => {
      openaiKeyVisible = !openaiKeyVisible;
      if (openaiKeyVisible && settings.openaiApiKey) {
        openaiKeyInput.type = 'text';
        openaiKeyInput.value = settings.openaiApiKey;
      } else {
        openaiKeyInput.type = 'password';
        if (settings.openaiApiKey) {
          openaiKeyInput.value = '‚Ä¢'.repeat(Math.min(settings.openaiApiKey.length, 40));
        }
      }
    });

    document.getElementById('toggle-gemini-key').addEventListener('click', () => {
      geminiKeyVisible = !geminiKeyVisible;
      if (geminiKeyVisible && settings.geminiApiKey) {
        geminiKeyInput.type = 'text';
        geminiKeyInput.value = settings.geminiApiKey;
      } else {
        geminiKeyInput.type = 'password';
        if (settings.geminiApiKey) {
          geminiKeyInput.value = '‚Ä¢'.repeat(Math.min(settings.geminiApiKey.length, 40));
        }
      }
    });

    document.getElementById('toggle-claude-key').addEventListener('click', () => {
      claudeKeyVisible = !claudeKeyVisible;
      if (claudeKeyVisible && settings.claudeApiKey) {
        claudeKeyInput.type = 'text';
        claudeKeyInput.value = settings.claudeApiKey;
      } else {
        claudeKeyInput.type = 'password';
        if (settings.claudeApiKey) {
          claudeKeyInput.value = '‚Ä¢'.repeat(Math.min(settings.claudeApiKey.length, 40));
        }
      }
    });

    openaiKeyInput.addEventListener('change', async (e) => {
      const value = e.target.value.trim();
      if (value && !value.startsWith('‚Ä¢')) {
        settings.openaiApiKey = value;
        if (await saveToStorage('openai_apiKey', value)) {
          updateStatus(openaiStatus, 'success', 'API key saved');
          showToast('OpenAI API key saved!');
        }
      }
    });

    geminiKeyInput.addEventListener('change', async (e) => {
      const value = e.target.value.trim();
      if (value && !value.startsWith('‚Ä¢')) {
        settings.geminiApiKey = value;
        if (await saveToStorage('gemini_apiKey', value)) {
          updateStatus(geminiStatus, 'success', 'API key saved');
          showToast('Gemini API key saved!');
        }
      }
    });

    claudeKeyInput.addEventListener('change', async (e) => {
      const value = e.target.value.trim();
      if (value && !value.startsWith('‚Ä¢')) {
        settings.claudeApiKey = value;
        if (await saveToStorage('claude_apiKey', value)) {
          updateStatus(claudeStatus, 'success', 'API key saved');
          showToast('Claude API key saved!');
        }
      }
    });

    // ==================== TEST CONNECTION ====================
    document.getElementById('test-ai-connection').addEventListener('click', async () => {
      const btn = document.getElementById('test-ai-connection');
      btn.disabled = true;
      btn.textContent = 'üîÑ Testing...';

      try {
        let testedAny = false;
        
        // Test OpenAI
        if (settings.openaiApiKey) {
          testedAny = true;
          try {
            const response = await fetch('https://api.openai.com/v1/models', {
              headers: { 'Authorization': `Bearer ${settings.openaiApiKey}` }
            });
            if (response.ok) {
              updateStatus(openaiStatus, 'success', 'Connected ‚úì');
            } else {
              updateStatus(openaiStatus, 'error', 'Invalid API key');
            }
          } catch (err) {
            updateStatus(openaiStatus, 'error', 'Connection failed');
          }
        }

        // Test Gemini
        if (settings.geminiApiKey) {
          testedAny = true;
          try {
            const response = await fetch(
              `https://generativelanguage.googleapis.com/v1beta/models?key=${settings.geminiApiKey}`
            );
            if (response.ok) {
              updateStatus(geminiStatus, 'success', 'Connected ‚úì');
            } else {
              updateStatus(geminiStatus, 'error', 'Invalid API key');
            }
          } catch (err) {
            updateStatus(geminiStatus, 'error', 'Connection failed');
          }
        }

        // Test Claude
        if (settings.claudeApiKey) {
          testedAny = true;
          try {
            const response = await fetch('https://api.anthropic.com/v1/messages', {
              method: 'POST',
              headers: {
                'x-api-key': settings.claudeApiKey,
                'anthropic-version': '2023-06-01',
                'content-type': 'application/json',
                'anthropic-dangerous-direct-browser-access': 'true'
              },
              body: JSON.stringify({
                model: 'claude-3-5-haiku-latest',
                max_tokens: 5,
                messages: [{ role: 'user', content: 'hi' }]
              })
            });
            // Any response (even 400 for invalid request) means API key is valid
            // 401 means invalid key
            if (response.status === 401 || response.status === 403) {
              updateStatus(claudeStatus, 'error', 'Invalid API key');
            } else {
              updateStatus(claudeStatus, 'success', 'Connected ‚úì');
            }
          } catch (err) {
            // CORS error is expected in browser, but key format can be validated
            if (settings.claudeApiKey.startsWith('sk-ant-')) {
              updateStatus(claudeStatus, 'warning', 'Key format valid (CORS blocked test)');
            } else {
              updateStatus(claudeStatus, 'error', 'Invalid key format');
            }
          }
        }

        if (testedAny) {
          showToast('Connection test complete!');
        } else {
          showToast('No API keys configured to test', 'warning');
        }
      } catch (error) {
        console.error('Test failed:', error);
        showToast('Connection test failed', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'üß™ Test AI Connection';
      }
    });

    // ==================== SELECT HANDLERS ====================
    aiProviderSelect.addEventListener('change', async (e) => {
      settings.aiProvider = e.target.value;
      await saveToStorage('ai_provider', e.target.value);
      showToast('AI provider updated');
    });

    if (openaiModelSelect) {
      openaiModelSelect.addEventListener('change', async (e) => {
        settings.openaiModel = e.target.value;
        await saveToStorage('openai_model', e.target.value);
        showToast('OpenAI model updated');
      });
    }

    if (geminiModelSelect) {
      geminiModelSelect.addEventListener('change', async (e) => {
        settings.geminiModel = e.target.value;
        await saveToStorage('gemini_model', e.target.value);
        showToast('Gemini model updated');
      });
    }

    if (claudeModelSelect) {
      claudeModelSelect.addEventListener('change', async (e) => {
        settings.claudeModel = e.target.value;
        await saveToStorage('claude_model', e.target.value);
        showToast('Claude model updated');
      });
    }

    // ==================== CHECKBOX HANDLERS ====================
    document.getElementById('auto-detect-forms').addEventListener('change', async (e) => {
      settings.autoDetectForms = e.target.checked;
      await saveSettings();
    });

    document.getElementById('show-floating-button').addEventListener('change', async (e) => {
      settings.showFloatingButton = e.target.checked;
      await saveSettings();
    });

    document.getElementById('enable-notifications').addEventListener('change', async (e) => {
      settings.enableNotifications = e.target.checked;
      await saveSettings();
    });

    document.getElementById('macro-auto-learn').addEventListener('change', async (e) => {
      settings.macroAutoLearn = e.target.checked;
      await saveSettings();
    });

    async function saveSettings() {
      await saveToStorage('settings', {
        autoDetectForms: settings.autoDetectForms,
        showFloatingButton: settings.showFloatingButton,
        enableNotifications: settings.enableNotifications,
        macroAutoLearn: settings.macroAutoLearn
      });
      showToast('Settings saved');
    }

    // ==================== THEME CARDS HANDLER ====================
    // Use event delegation for theme cards to ensure they work
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üìã Settings page DOM loaded');
      
      // Re-query theme cards after DOM is ready
      const allThemeCards = document.querySelectorAll('.settings-card[data-theme]');
      console.log('üé® Found theme cards:', allThemeCards.length);
      
      allThemeCards.forEach((card, index) => {
        console.log(`üé® Setting up card ${index}:`, card.dataset.theme);
        
        // Remove any existing listeners by cloning
        const newCard = card.cloneNode(true);
        card.parentNode.replaceChild(newCard, card);
        
        newCard.addEventListener('click', async function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const selectedTheme = this.dataset.theme;
          console.log('üé® Theme card clicked:', selectedTheme);
          
          // Update visual state
          document.querySelectorAll('.settings-card[data-theme]').forEach(c => {
            c.classList.remove('active');
          });
          this.classList.add('active');
          
          // Save to storage
          settings.theme = selectedTheme;
          try {
            await chrome.storage.local.set({ theme: selectedTheme });
            showToast(`Theme changed to ${this.querySelector('h4').textContent}`);
            console.log('üé® Theme saved:', selectedTheme);
          } catch (error) {
            console.error('Failed to save theme:', error);
            showToast('Failed to save theme', 'error');
          }
        });
        
        // Add hover effect
        newCard.style.cursor = 'pointer';
      });
    });

    // ==================== DATA MANAGEMENT ====================
    // Export data handler
    const exportBtn = document.getElementById('export-data');
    if (exportBtn) {
      exportBtn.addEventListener('click', async () => {
        console.log('üì§ Export button clicked');
        try {
          const data = await chrome.storage.local.get(null);
          // Remove sensitive data
          const exportData = { ...data };
          delete exportData.openai_apiKey;
          delete exportData.gemini_apiKey;
          delete exportData.claude_apiKey;
          
          const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `cube-nexum-export-${new Date().toISOString().split('T')[0]}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          showToast('Data exported successfully');
        } catch (error) {
          console.error('Export failed:', error);
          showToast('Export failed: ' + error.message, 'error');
        }
      });
    }

    // Import data handler
    const importBtn = document.getElementById('import-data');
    const importFileInput = document.getElementById('import-file-input');
    
    if (importBtn && importFileInput) {
      importBtn.addEventListener('click', () => {
        console.log('üì• Import button clicked');
        importFileInput.click();
      });
      
      importFileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        console.log('üì• File selected:', file.name);
        
        try {
          const text = await file.text();
          const data = JSON.parse(text);
          await chrome.storage.local.set(data);
          showToast('Data imported successfully');
          setTimeout(() => location.reload(), 1000);
        } catch (error) {
          console.error('Import failed:', error);
          showToast('Import failed - invalid file', 'error');
        }
        
        // Reset file input
        importFileInput.value = '';
      });
    }

    // Clear macros handler
    const clearMacrosBtn = document.getElementById('clear-macros');
    if (clearMacrosBtn) {
      clearMacrosBtn.addEventListener('click', async () => {
        console.log('üóëÔ∏è Clear macros clicked');
        if (confirm('Are you sure you want to delete all saved macros?')) {
          try {
            await chrome.storage.local.remove(['macros', 'savedMacros']);
            showToast('Macros cleared');
          } catch (error) {
            console.error('Clear macros failed:', error);
            showToast('Failed to clear macros', 'error');
          }
        }
      });
    }

    // Clear chat history handler
    const clearChatBtn = document.getElementById('clear-chat-history');
    if (clearChatBtn) {
      clearChatBtn.addEventListener('click', async () => {
        console.log('üóëÔ∏è Clear chat clicked');
        if (confirm('Are you sure you want to delete all chat history?')) {
          try {
            await chrome.storage.local.remove(['aiConversations', 'chatConversations', 'chatMessages', 'cubeAIHistory']);
            showToast('Chat history cleared');
          } catch (error) {
            console.error('Clear chat failed:', error);
            showToast('Failed to clear chat history', 'error');
          }
        }
      });
    }

    // Reset all handler
    const resetAllBtn = document.getElementById('reset-all');
    if (resetAllBtn) {
      resetAllBtn.addEventListener('click', async () => {
        console.log('‚ö†Ô∏è Reset all clicked');
        if (confirm('‚ö†Ô∏è This will reset ALL settings and data. Are you sure?')) {
          if (confirm('This action cannot be undone. Continue?')) {
            try {
              await chrome.storage.local.clear();
              showToast('All settings reset');
              setTimeout(() => location.reload(), 1000);
            } catch (error) {
              console.error('Reset failed:', error);
              showToast('Reset failed', 'error');
            }
          }
        }
      });
    }

    // ==================== THEME TOGGLE ====================
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = document.getElementById('theme-icon');
    const themeText = document.getElementById('theme-text');

    async function loadTheme() {
      const result = await chrome.storage.local.get('settings_theme');
      const savedTheme = result.settings_theme || 'light';
      applyTheme(savedTheme);
    }

    function applyTheme(theme) {
      document.body.setAttribute('data-theme', theme);
      if (theme === 'dark') {
        themeIcon.textContent = '‚òÄÔ∏è';
        themeText.textContent = 'Light';
      } else {
        themeIcon.textContent = 'üåô';
        themeText.textContent = 'Dark';
      }
    }

    themeToggle.addEventListener('click', async () => {
      const currentTheme = document.body.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      applyTheme(newTheme);
      await chrome.storage.local.set({ settings_theme: newTheme });
      showToast(`Theme changed to ${newTheme}`);
    });

    // Load theme on page load
    loadTheme();

    // ==================== INIT ====================
    init();
  </script>
</body>
</html>
